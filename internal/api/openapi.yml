openapi: 3.0.3
info:
  title: DBBat API
  description: |
    REST API for DBBat PostgreSQL Observability Proxy.

    DBBat is a transparent PostgreSQL proxy for query observability, access control, and safety.

    ## Authentication

    The API supports two authentication methods:

    - **Basic Auth**: HTTP Basic Authentication using username and password
    - **Bearer Token**: API key authentication using `Authorization: Bearer <api-key>`

    API keys cannot create or revoke other API keys (security restriction) - these operations require Basic Auth.

    ## Roles

    Users have one or more roles that determine their access:

    - **admin**: Full access to all resources and operations
    - **viewer**: Read-only access to observability data (connections, queries, audit)
    - **connector**: Can only access databases they have active grants for

    ## Password Change Requirement

    Users must change their initial password before logging in.
    Login attempts from users who haven't changed their password will receive a `403 Forbidden` response with error code `password_change_required`.
    Users must then call `PUT /auth/password` with their username and credentials to change their password before they can log in.

    ## Rate Limiting

    All authenticated endpoints are rate-limited. Response headers include:

    - `X-RateLimit-Limit`: Maximum requests per minute
    - `X-RateLimit-Remaining`: Remaining requests in current window
    - `X-RateLimit-Reset`: Unix timestamp when limit resets

    ## Authentication Rate Limiting

    Failed login attempts are rate-limited per username with exponential backoff:

    - 1-2 failures: no delay
    - 3-4 failures: 5 seconds
    - 5-6 failures: 30 seconds
    - 7-9 failures: 2 minutes
    - 10+ failures: 5 minutes

    Rate-limited authentication attempts receive a `429 Too Many Requests` response with error code `auth_rate_limited`.
  version: 1.0.0
  contact:
    name: DBBat

servers:
  - url: /api/v1
    description: API v1 server

tags:
  - name: Health
    description: Health check endpoint
  - name: Version
    description: Version and build information
  - name: Auth
    description: Authentication (login, logout, session management)
  - name: Users
    description: User management
  - name: Databases
    description: Database configuration management
  - name: Grants
    description: Access grant management
  - name: API Keys
    description: API key management
  - name: Connections
    description: Connection observability
  - name: Queries
    description: Query observability
  - name: Audit
    description: Audit log

security:
  - basicAuth: []
  - bearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the API server and database connection.
      operationId: getHealth
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /version:
    get:
      tags:
        - Version
      summary: Get version information
      description: Returns API version and build information.
      operationId: getVersion
      security: []
      responses:
        '200':
          description: Version information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionInfo'

  /auth/login:
    post:
      tags:
        - Auth
      summary: Login and create web session
      description: |
        Authenticates with username/password and creates a short-lived web session token.

        The token should be stored and used as a Bearer token for subsequent API calls.
        Web session tokens expire after 1 hour.

        **Important**: Users who haven't changed their initial password will receive a 403 error.
        They must first change their password using `PUT /auth/password` before logging in.
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Password change required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PasswordChangeRequiredError'
        '429':
          $ref: '#/components/responses/AuthRateLimited'

  /auth/logout:
    post:
      tags:
        - Auth
      summary: Logout and revoke web session
      description: |
        Revokes the current web session token.

        After logout, the token will no longer be valid for authentication.
      operationId: logout
      responses:
        '204':
          description: Logout successful
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      tags:
        - Auth
      summary: Get current user and session info
      description: |
        Returns information about the currently authenticated user and their session.

        Use this endpoint to:
        - Validate that a session token is still valid
        - Check if password change is required
        - Get session expiration time
      operationId: getCurrentUser
      responses:
        '200':
          description: Current user and session info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/password:
    put:
      tags:
        - Auth
      summary: Change password (pre-login)
      description: |
        Allows users to change their password before logging in.
        Used for initial password change or password reset flows.

        Does not require authentication - validates username/current_password.
        Subject to rate limiting (same as login).

        After changing password, users can login using `POST /auth/login`.
      operationId: changePasswordPreLogin
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreLoginPasswordChangeRequest'
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Weak password
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum: [weak_password]
                  message:
                    type: string
                required:
                  - error
                  - message
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/AuthRateLimited'

  /users:
    post:
      tags:
        - Users
      summary: Create a new user
      description: Creates a new user account. Requires admin role.
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '200':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - Users
      summary: List users
      description: |
        Returns a list of users.

        - Admins see all users
        - Non-admins see only themselves
      operationId: listUsers
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /users/{uid}:
    parameters:
      - $ref: '#/components/parameters/UserUID'

    get:
      tags:
        - Users
      summary: Get user by UID
      description: Retrieves a specific user by their UID.
      operationId: getUser
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

    put:
      tags:
        - Users
      summary: Update user
      description: |
        Updates a user account.

        - Non-admins can only update their own password
        - Non-admins cannot change roles
        - API keys cannot change passwords (requires Basic Auth)
      operationId: updateUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - Users
      summary: Delete user
      description: |
        Deletes a user account. Requires admin role.

        Note: Cannot delete your own user account.
      operationId: deleteUser
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /users/{uid}/password:
    parameters:
      - $ref: '#/components/parameters/UserUID'

    put:
      tags:
        - Users
      summary: Change password (authenticated)
      description: |
        Changes a user's password. Requires re-authentication via username/password in the request body.

        **Important**: This endpoint does NOT use Bearer token authentication.
        Users must provide their username and current password for re-authentication.

        - Users can only change their own password
        - Admin users can change any user's password (with their own admin credentials)
        - Subject to rate limiting (same as login)
      operationId: changePassword
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Weak password
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum: [weak_password]
                  message:
                    type: string
                required:
                  - error
                  - message
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Cannot change another user's password (non-admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/AuthRateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /databases:
    post:
      tags:
        - Databases
      summary: Create database configuration
      description: Creates a new database configuration. Requires admin role.
      operationId: createDatabase
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDatabaseRequest'
      responses:
        '200':
          description: Database created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Database'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - Databases
      summary: List databases
      description: |
        Returns a list of database configurations.

        Response varies by role:
        - **Admin**: Full details (host, port, database_name, username, ssl_mode)
        - **Viewer**: Limited info (uid, name, description)
        - **Connector**: Only databases they have active grants for (limited info)
      operationId: listDatabases
      responses:
        '200':
          description: List of databases
          content:
            application/json:
              schema:
                type: object
                properties:
                  databases:
                    type: array
                    items:
                      oneOf:
                        - $ref: '#/components/schemas/Database'
                        - $ref: '#/components/schemas/DatabaseLimited'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /databases/{uid}:
    parameters:
      - $ref: '#/components/parameters/DatabaseUID'

    get:
      tags:
        - Databases
      summary: Get database by UID
      description: |
        Retrieves a specific database configuration.

        Response varies by role:
        - **Admin**: Full details
        - **Viewer**: Limited info
        - **Connector**: Only if they have an active grant (limited info)
      operationId: getDatabase
      responses:
        '200':
          description: Database details
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Database'
                  - $ref: '#/components/schemas/DatabaseLimited'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

    put:
      tags:
        - Databases
      summary: Update database
      description: Updates a database configuration. Requires admin role.
      operationId: updateDatabase
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDatabaseRequest'
      responses:
        '200':
          description: Database updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - Databases
      summary: Delete database
      description: Deletes a database configuration. Requires admin role.
      operationId: deleteDatabase
      responses:
        '200':
          description: Database deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /grants:
    post:
      tags:
        - Grants
      summary: Create access grant
      description: Creates a new access grant for a user to a database. Requires admin role.
      operationId: createGrant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGrantRequest'
      responses:
        '200':
          description: Grant created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessGrant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - Grants
      summary: List grants
      description: |
        Returns a list of access grants.

        Connectors can only see their own grants.
      operationId: listGrants
      parameters:
        - name: user_id
          in: query
          description: Filter by user UID
          schema:
            type: string
            format: uuid
        - name: database_id
          in: query
          description: Filter by database UID
          schema:
            type: string
            format: uuid
        - name: active_only
          in: query
          description: Only return active (non-revoked, within time window) grants
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of grants
          content:
            application/json:
              schema:
                type: object
                properties:
                  grants:
                    type: array
                    items:
                      $ref: '#/components/schemas/AccessGrant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /grants/{uid}:
    parameters:
      - $ref: '#/components/parameters/GrantUID'

    get:
      tags:
        - Grants
      summary: Get grant by UID
      description: |
        Retrieves a specific access grant.

        Connectors can only see their own grants.
      operationId: getGrant
      responses:
        '200':
          description: Grant details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessGrant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

    delete:
      tags:
        - Grants
      summary: Revoke grant
      description: Revokes an access grant. Requires admin role.
      operationId: revokeGrant
      responses:
        '200':
          description: Grant revoked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /keys:
    post:
      tags:
        - API Keys
      summary: Create API key
      description: |
        Creates a new API key for the authenticated user.

        **Important**: The full API key is only returned once in this response.
        Store it securely as it cannot be retrieved later.

        Requires Web Session or Basic Auth (API keys cannot create other API keys).
      operationId: createAPIKey
      security:
        - basicAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAPIKeyRequest'
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAPIKeyResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - API Keys
      summary: List API keys
      description: |
        Returns a list of API keys.

        - Non-admins can only see their own keys
        - Admins can see all keys (optionally filter by user_id)
      operationId: listAPIKeys
      parameters:
        - name: user_id
          in: query
          description: Filter by user UID (admin only)
          schema:
            type: string
            format: uuid
        - name: include_all
          in: query
          description: Include revoked and expired keys
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      $ref: '#/components/schemas/APIKey'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /keys/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: API key ID
        schema:
          type: string
          format: uuid

    get:
      tags:
        - API Keys
      summary: Get API key by ID
      description: |
        Retrieves a specific API key.

        Non-admins can only see their own keys.
      operationId: getAPIKey
      responses:
        '200':
          description: API key details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKey'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

    delete:
      tags:
        - API Keys
      summary: Revoke API key
      description: |
        Revokes an API key.

        - Non-admins can only revoke their own keys
        - Requires Web Session or Basic Auth (API keys cannot revoke API keys)
      operationId: revokeAPIKey
      security:
        - basicAuth: []
        - bearerAuth: []
      responses:
        '204':
          description: API key revoked successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /connections:
    get:
      tags:
        - Connections
      summary: List connections
      description: |
        Returns a list of proxy connections.

        Connectors can only see their own connections.
      operationId: listConnections
      parameters:
        - name: user_id
          in: query
          description: Filter by user UID
          schema:
            type: string
            format: uuid
        - name: database_id
          in: query
          description: Filter by database UID
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of connections
          content:
            application/json:
              schema:
                type: object
                properties:
                  connections:
                    type: array
                    items:
                      $ref: '#/components/schemas/Connection'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /queries:
    get:
      tags:
        - Queries
      summary: List queries
      description: |
        Returns a list of executed queries.

        Requires admin or viewer role.
      operationId: listQueries
      parameters:
        - name: connection_id
          in: query
          description: Filter by connection UID
          schema:
            type: string
            format: uuid
        - name: user_id
          in: query
          description: Filter by user UID
          schema:
            type: string
            format: uuid
        - name: database_id
          in: query
          description: Filter by database UID
          schema:
            type: string
            format: uuid
        - name: start_time
          in: query
          description: Filter by start time (RFC3339 format)
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: Filter by end time (RFC3339 format)
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of queries
          content:
            application/json:
              schema:
                type: object
                properties:
                  queries:
                    type: array
                    items:
                      $ref: '#/components/schemas/Query'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /queries/{uid}:
    parameters:
      - $ref: '#/components/parameters/QueryUID'

    get:
      tags:
        - Queries
      summary: Get query details
      description: |
        Retrieves a specific query without its result rows.

        Use `GET /queries/{uid}/rows` to retrieve the result rows.

        Requires admin or viewer role.
      operationId: getQuery
      responses:
        '200':
          description: Query details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Query'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

  /queries/{uid}/rows:
    parameters:
      - $ref: '#/components/parameters/QueryUID'

    get:
      tags:
        - Queries
      summary: List query result rows (paginated)
      description: |
        Retrieves paginated result rows for a specific query.

        Uses cursor-based pagination with two limits per request:
        - Maximum 1000 rows per response
        - Maximum 1MB of row data per response

        The response stops at whichever limit is reached first.

        Requires admin or viewer role.
      operationId: getQueryRows
      parameters:
        - name: cursor
          in: query
          description: Pagination cursor from previous response
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of rows to return
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Query rows retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryRowsResponse'
        '400':
          description: Invalid cursor or limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/RateLimited'

  /audit:
    get:
      tags:
        - Audit
      summary: List audit events
      description: |
        Returns a list of audit log events.

        Requires admin or viewer role.
      operationId: listAudit
      parameters:
        - name: event_type
          in: query
          description: Filter by event type (e.g., user.created, grant.revoked)
          schema:
            type: string
        - name: user_id
          in: query
          description: Filter by user UID (the user being acted upon)
          schema:
            type: string
            format: uuid
        - name: performed_by
          in: query
          description: Filter by performer UID (the user performing the action)
          schema:
            type: string
            format: uuid
        - name: start_time
          in: query
          description: Filter by start time (RFC3339 format)
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: Filter by end time (RFC3339 format)
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  audit_events:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: HTTP Basic Authentication (username:password)
    bearerAuth:
      type: http
      scheme: bearer
      description: API key authentication (Bearer token)

  parameters:
    UserUID:
      name: uid
      in: path
      required: true
      description: User UID
      schema:
        type: string
        format: uuid

    DatabaseUID:
      name: uid
      in: path
      required: true
      description: Database UID
      schema:
        type: string
        format: uuid

    GrantUID:
      name: uid
      in: path
      required: true
      description: Grant UID
      schema:
        type: string
        format: uuid

    QueryUID:
      name: uid
      in: path
      required: true
      description: Query UID
      schema:
        type: string
        format: uuid

    Limit:
      name: limit
      in: query
      description: Maximum number of results to return
      schema:
        type: integer
        default: 100
        minimum: 1
        maximum: 1000

    Offset:
      name: offset
      in: query
      description: Number of results to skip for pagination
      schema:
        type: integer
        default: 0
        minimum: 0

  schemas:
    # Version schemas
    VersionInfo:
      type: object
      description: API and build version information
      properties:
        api_version:
          type: string
          description: API version (e.g., "v1")
          example: v1
        build_version:
          type: string
          description: Build version
          example: 1.2.3
        build_commit:
          type: string
          description: Git commit hash
          example: abc1234
        build_time:
          type: string
          format: date-time
          description: Build timestamp
          example: "2026-01-09T12:00:00Z"
      required:
        - api_version
        - build_version
        - build_commit
        - build_time

    # Auth schemas
    LoginRequest:
      type: object
      properties:
        username:
          type: string
          description: Username
        password:
          type: string
          format: password
          description: Password
      required:
        - username
        - password

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: Web session token (use as Bearer token)
        expires_at:
          type: string
          format: date-time
          description: Token expiration time
        user:
          $ref: '#/components/schemas/AuthUser'
      required:
        - token
        - expires_at
        - user

    AuthUser:
      type: object
      description: User info returned in auth responses
      properties:
        uid:
          type: string
          format: uuid
          description: User UID
        username:
          type: string
          description: Username
        roles:
          type: array
          items:
            type: string
            enum: [admin, viewer, connector]
          description: User roles
        password_change_required:
          type: boolean
          description: Whether user must change their password
      required:
        - uid
        - username
        - roles
        - password_change_required

    MeResponse:
      type: object
      properties:
        uid:
          type: string
          format: uuid
          description: User UID
        username:
          type: string
          description: Username
        roles:
          type: array
          items:
            type: string
            enum: [admin, viewer, connector]
          description: User roles
        password_change_required:
          type: boolean
          description: Whether user must change their password
        session:
          $ref: '#/components/schemas/SessionInfo'
      required:
        - uid
        - username
        - roles
        - password_change_required
        - session

    SessionInfo:
      type: object
      description: Current session information
      properties:
        expires_at:
          type: string
          format: date-time
          description: Session expiration time
        created_at:
          type: string
          format: date-time
          description: Session creation time

    ChangePasswordRequest:
      type: object
      description: Request for authenticated password change (re-authentication required)
      properties:
        username:
          type: string
          description: Username for re-authentication
        current_password:
          type: string
          format: password
          description: Current password for re-authentication
        new_password:
          type: string
          format: password
          description: New password (minimum 8 characters)
      required:
        - username
        - current_password
        - new_password

    PreLoginPasswordChangeRequest:
      type: object
      description: Request for pre-login password change (no token required)
      properties:
        username:
          type: string
          description: Username
        current_password:
          type: string
          format: password
          description: Current/temporary password
        new_password:
          type: string
          format: password
          description: New password (minimum 8 characters)
      required:
        - username
        - current_password
        - new_password

    # User schemas
    User:
      type: object
      properties:
        uid:
          type: string
          format: uuid
          description: Unique identifier
        username:
          type: string
          description: Username
        roles:
          type: array
          items:
            type: string
            enum: [admin, viewer, connector]
          description: User roles
        rate_limit_exempt:
          type: boolean
          description: Whether user bypasses rate limiting
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
      required:
        - uid
        - username
        - roles
        - rate_limit_exempt
        - created_at
        - updated_at

    CreateUserRequest:
      type: object
      properties:
        username:
          type: string
          minLength: 1
          description: Username
        password:
          type: string
          minLength: 1
          description: Password
        roles:
          type: array
          items:
            type: string
            enum: [admin, viewer, connector]
          description: User roles
      required:
        - username
        - password

    UpdateUserRequest:
      type: object
      properties:
        password:
          type: string
          description: New password
        roles:
          type: array
          items:
            type: string
            enum: [admin, viewer, connector]
          description: New roles (admin only)

    # Database schemas
    Database:
      type: object
      description: Full database details (admin only)
      properties:
        uid:
          type: string
          format: uuid
          description: Unique identifier
        name:
          type: string
          description: Database configuration name
        description:
          type: string
          description: Description
        host:
          type: string
          description: Target database host
        port:
          type: integer
          description: Target database port
        database_name:
          type: string
          description: Target database name
        username:
          type: string
          description: Target database username
        ssl_mode:
          type: string
          description: SSL mode (disable, prefer, require, etc.)
        created_by:
          type: string
          format: uuid
          nullable: true
          description: User who created this configuration
      required:
        - uid
        - name

    DatabaseLimited:
      type: object
      description: Limited database info for non-admin users
      properties:
        uid:
          type: string
          format: uuid
          description: Unique identifier
        name:
          type: string
          description: Database configuration name
        description:
          type: string
          description: Description
      required:
        - uid
        - name

    CreateDatabaseRequest:
      type: object
      properties:
        name:
          type: string
          description: Unique name for this database configuration
        description:
          type: string
          description: Description
        host:
          type: string
          description: Target database host
        port:
          type: integer
          default: 5432
          description: Target database port
        database_name:
          type: string
          description: Target database name
        username:
          type: string
          description: Target database username
        password:
          type: string
          description: Target database password (encrypted at rest)
        ssl_mode:
          type: string
          default: prefer
          description: SSL mode
      required:
        - name
        - host
        - database_name
        - username
        - password

    UpdateDatabaseRequest:
      type: object
      properties:
        description:
          type: string
          description: Description
        host:
          type: string
          description: Target database host
        port:
          type: integer
          description: Target database port
        database_name:
          type: string
          description: Target database name
        username:
          type: string
          description: Target database username
        password:
          type: string
          description: Target database password (encrypted at rest)
        ssl_mode:
          type: string
          description: SSL mode

    # Grant schemas
    GrantControl:
      type: string
      enum:
        - read_only
        - block_copy
        - block_ddl
      description: |
        Control types that can be applied to a grant:
        - `read_only`: Enables PostgreSQL session read-only mode and blocks write queries
        - `block_copy`: Blocks all COPY commands (both TO and FROM)
        - `block_ddl`: Blocks DDL statements (CREATE, ALTER, DROP, TRUNCATE)

    AccessGrant:
      type: object
      properties:
        uid:
          type: string
          format: uuid
          description: Unique identifier
        user_id:
          type: string
          format: uuid
          description: User UID
        database_id:
          type: string
          format: uuid
          description: Database UID
        controls:
          type: array
          items:
            $ref: '#/components/schemas/GrantControl'
          description: List of controls applied. Empty array means full write access.
        granted_by:
          type: string
          format: uuid
          description: Admin who granted access
        starts_at:
          type: string
          format: date-time
          description: When access starts
        expires_at:
          type: string
          format: date-time
          description: When access expires
        revoked_at:
          type: string
          format: date-time
          nullable: true
          description: When access was revoked (null if active)
        revoked_by:
          type: string
          format: uuid
          nullable: true
          description: Admin who revoked access
        max_query_counts:
          type: integer
          format: int64
          nullable: true
          description: Maximum queries allowed (quota)
        max_bytes_transferred:
          type: integer
          format: int64
          nullable: true
          description: Maximum bytes transferred (quota)
        query_count:
          type: integer
          format: int64
          description: Current query count
        bytes_transferred:
          type: integer
          format: int64
          description: Current bytes transferred
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
      required:
        - uid
        - user_id
        - database_id
        - controls
        - granted_by
        - starts_at
        - expires_at
        - created_at

    CreateGrantRequest:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          description: User UID
        database_id:
          type: string
          format: uuid
          description: Database UID
        controls:
          type: array
          items:
            $ref: '#/components/schemas/GrantControl'
          default: []
          description: List of controls to apply. Empty array means full write access.
        starts_at:
          type: string
          format: date-time
          description: When access starts
        expires_at:
          type: string
          format: date-time
          description: When access expires (must be after starts_at)
        max_query_counts:
          type: integer
          format: int64
          description: Maximum queries allowed (quota)
        max_bytes_transferred:
          type: integer
          format: int64
          description: Maximum bytes transferred (quota)
      required:
        - user_id
        - database_id
        - starts_at
        - expires_at

    # API Key schemas
    APIKey:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier
        user_id:
          type: string
          format: uuid
          description: User UID
        name:
          type: string
          description: Key name
        key_prefix:
          type: string
          description: Key prefix for identification
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When the key expires
        last_used_at:
          type: string
          format: date-time
          nullable: true
          description: When the key was last used
        request_count:
          type: integer
          format: int64
          description: Total requests made with this key
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        revoked_at:
          type: string
          format: date-time
          nullable: true
          description: When the key was revoked
        revoked_by:
          type: string
          format: uuid
          nullable: true
          description: User who revoked the key
      required:
        - id
        - user_id
        - name
        - key_prefix
        - request_count
        - created_at

    CreateAPIKeyRequest:
      type: object
      properties:
        name:
          type: string
          description: Key name
        expires_at:
          type: string
          format: date-time
          description: Optional expiration time
      required:
        - name

    CreateAPIKeyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier
        name:
          type: string
          description: Key name
        key:
          type: string
          description: Full API key (only shown once!)
        key_prefix:
          type: string
          description: Key prefix for identification
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When the key expires
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
      required:
        - id
        - name
        - key
        - key_prefix
        - created_at

    # Connection schemas
    Connection:
      type: object
      properties:
        uid:
          type: string
          format: uuid
          description: Unique identifier
        user_id:
          type: string
          format: uuid
          description: User UID
        database_id:
          type: string
          format: uuid
          description: Database UID
        source_ip:
          type: string
          description: Client IP address
        connected_at:
          type: string
          format: date-time
          description: Connection start time
        last_activity_at:
          type: string
          format: date-time
          description: Last activity timestamp
        disconnected_at:
          type: string
          format: date-time
          nullable: true
          description: Connection end time (null if still connected)
        queries:
          type: integer
          format: int64
          description: Number of queries executed
        bytes_transferred:
          type: integer
          format: int64
          description: Total bytes transferred
      required:
        - uid
        - user_id
        - database_id
        - source_ip
        - connected_at
        - last_activity_at
        - queries
        - bytes_transferred

    # Query schemas
    Query:
      type: object
      properties:
        uid:
          type: string
          format: uuid
          description: Unique identifier
        connection_id:
          type: string
          format: uuid
          description: Connection UID
        sql_text:
          type: string
          description: SQL query text
        parameters:
          $ref: '#/components/schemas/QueryParameters'
        executed_at:
          type: string
          format: date-time
          description: Execution timestamp
        duration_ms:
          type: number
          format: double
          nullable: true
          description: Execution duration in milliseconds
        rows_affected:
          type: integer
          format: int64
          nullable: true
          description: Number of rows affected
        error:
          type: string
          nullable: true
          description: Error message if query failed
      required:
        - uid
        - connection_id
        - sql_text
        - executed_at

    QueryParameters:
      type: object
      description: Query parameter values (for prepared statements)
      properties:
        values:
          type: array
          items:
            type: string
          description: Decoded string representations
        raw:
          type: array
          items:
            type: string
          description: Base64-encoded raw bytes
        format_codes:
          type: array
          items:
            type: integer
          description: Format codes (0=text, 1=binary)
        type_oids:
          type: array
          items:
            type: integer
          description: PostgreSQL type OIDs

    QueryWithRows:
      allOf:
        - $ref: '#/components/schemas/Query'
        - type: object
          properties:
            rows:
              type: array
              items:
                $ref: '#/components/schemas/QueryRow'
              description: Result rows (from SELECT or COPY operations)

    QueryRow:
      type: object
      properties:
        row_number:
          type: integer
          description: Row index
        row_data:
          type: object
          additionalProperties: true
          description: Row data as JSON object
        row_size_bytes:
          type: integer
          format: int64
          description: Row size in bytes
      required:
        - row_number
        - row_data
        - row_size_bytes

    QueryRowsResponse:
      type: object
      description: Paginated query rows response
      properties:
        rows:
          type: array
          items:
            $ref: '#/components/schemas/QueryRow'
          description: Array of row objects
        next_cursor:
          type: string
          nullable: true
          description: Cursor for the next page (null if no more rows)
        has_more:
          type: boolean
          description: Whether more rows are available
        total_rows:
          type: integer
          format: int64
          description: Total number of rows for this query
      required:
        - rows
        - has_more
        - total_rows

    # Audit schemas
    AuditEvent:
      type: object
      properties:
        uid:
          type: string
          format: uuid
          description: Unique identifier
        event_type:
          type: string
          description: Event type (e.g., user.created, grant.revoked)
        user_id:
          type: string
          format: uuid
          nullable: true
          description: User being acted upon
        performed_by:
          type: string
          format: uuid
          nullable: true
          description: User performing the action
        details:
          type: object
          additionalProperties: true
          description: Event-specific details
        created_at:
          type: string
          format: date-time
          description: Event timestamp
      required:
        - uid
        - event_type
        - created_at

    # Common schemas
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
      required:
        - error

    RateLimitError:
      type: object
      properties:
        error:
          type: string
          example: rate_limit_exceeded
        message:
          type: string
          example: Too many requests. Please retry after 60 seconds.
        retry_after:
          type: integer
          description: Seconds until retry is allowed
      required:
        - error
        - message
        - retry_after

    PasswordChangeRequiredError:
      type: object
      description: Returned when user hasn't changed their initial password
      properties:
        error:
          type: string
          enum: [password_change_required]
          example: password_change_required
        message:
          type: string
          example: You must change your password before accessing the API
      required:
        - error
        - message

    AuthRateLimitedError:
      type: object
      description: Returned when too many failed login attempts
      properties:
        error:
          type: string
          enum: [auth_rate_limited]
          example: auth_rate_limited
        message:
          type: string
          example: Too many failed login attempts. Try again in 30 seconds.
        retry_after:
          type: integer
          description: Seconds until retry is allowed
          example: 30
      required:
        - error
        - message
        - retry_after

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
      required:
        - message

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    AuthRateLimited:
      description: Too many failed authentication attempts
      headers:
        Retry-After:
          description: Seconds until retry is allowed
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthRateLimitedError'

    Forbidden:
      description: Insufficient permissions or password change required
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/Error'
              - $ref: '#/components/schemas/PasswordChangeRequiredError'

    PasswordChangeRequired:
      description: User must change their initial password before accessing the API
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/PasswordChangeRequiredError'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    RateLimited:
      description: Rate limit exceeded
      headers:
        Retry-After:
          description: Seconds until retry is allowed
          schema:
            type: integer
        X-RateLimit-Limit:
          description: Maximum requests per minute
          schema:
            type: integer
        X-RateLimit-Remaining:
          description: Remaining requests in current window
          schema:
            type: integer
        X-RateLimit-Reset:
          description: Unix timestamp when limit resets
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RateLimitError'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
