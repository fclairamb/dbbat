# Demo Mode (DBB_RUN_MODE=demo)

## Overview

Add a new run mode `demo` designed for public demos, trials, and showcases. Unlike `test` mode (which wipes data on startup for E2E testing), demo mode provides a persistent, safe environment where users can explore DBBat without risk of exposing real databases.

## Goals

1. **Easy onboarding**: Pre-filled credentials and forms reduce friction for first-time users
2. **Safe by default**: Prevent accidental connection to production databases
3. **Clear context**: Visual indicator ensures users know they're in demo mode
4. **Persistent exploration**: Data persists between restarts (unlike test mode)

## Requirements

### 1. Run Mode Activation

**Environment variable**: `DBB_RUN_MODE=demo`

**Startup behavior**:
- Log warning: `"WARNING: Running in DEMO mode. Do not use in production environments."`
- Create sample data if database is empty (see section 6)
- Do NOT wipe existing data (unlike test mode)

### 2. Admin Password Protection

**Requirement**: The admin password must always remain `admin`/`admin` in demo mode.

**Implementation**:

| Layer | Behavior |
|-------|----------|
| API | `PUT /api/v1/auth/password` and `PUT /api/v1/users/:uid/password` return `403` with error `"password_change_disabled_in_demo_mode"` when attempting to change admin's password |
| Frontend | Hide "Change Password" option for admin user in demo mode |
| Startup | Ensure admin password is set to `admin` and marked as changed (so no forced password change flow) |

**Note**: Non-admin users CAN change their passwords in demo mode.

### 3. Localhost-Only Database Restriction

**Requirement**: Target database hosts must resolve to localhost only.

**Allowed hosts**:
- `localhost`
- `127.0.0.1`
- `::1` (IPv6 loopback)
- Docker service names when running in docker-compose (configurable, see below)

**Implementation**:

| Layer | Behavior |
|-------|----------|
| API | `POST /api/v1/databases` and `PUT /api/v1/databases/:uid` validate host against allowed list. Return `400` with error `"demo_mode_localhost_only"` if validation fails |
| Frontend | Pre-fill host field with `localhost`, make it read-only with tooltip explaining the restriction |

**Configuration option** (optional enhancement):
```
DBB_DEMO_ALLOWED_HOSTS=localhost,127.0.0.1,::1,postgres
```
This allows operators running docker-compose demos to permit internal service names.

### 4. Visual "Demo Mode" Indicator

**Component**: Floating badge in bottom-left corner of the application.

**Design**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚                        Main Application                      â”‚
â”‚                                                              â”‚
â”‚                                                              â”‚
â”‚                                                              â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ® Demo Mode                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Specifications**:
- **Position**: Fixed, bottom-left corner (16px from edges)
- **Style**: Pill/badge with subtle background (e.g., amber/yellow theme)
- **Text**: "Demo Mode" or "ğŸ® Demo Mode"
- **Tooltip on hover**: "Running in demo mode. Login: admin / admin. Database hosts restricted to localhost."
- **Z-index**: High enough to always be visible, but not blocking modals

### 5. Pre-filled Fields

#### 5.1 Login Page

| Field | Pre-filled Value | Editable |
|-------|------------------|----------|
| Username | `admin` | Yes |
| Password | `admin` | Yes |

**Additional UI**:
- Show helper text below the form: "Demo credentials pre-filled. Click Login to continue."
- Or show a dismissible info banner at the top of the login card

#### 5.2 Database Creation/Edit Form

| Field | Pre-filled Value | Editable |
|-------|------------------|----------|
| Host | `localhost` | No (read-only with tooltip) |
| Port | `5432` | Yes |
| Database | (empty) | Yes |
| Username | (empty) | Yes |
| Password | (empty) | Yes |
| SSL Mode | `disable` | Yes |

**Tooltip for host field**: "In demo mode, only localhost connections are allowed."

#### 5.3 Other Forms

No pre-filling needed. Normal behavior with appropriate placeholders.

### 6. Sample Data on Startup

When starting in demo mode, create sample data **only if the relevant tables are empty**:

| Entity | Details |
|--------|---------|
| Admin user | Username: `admin`, Password: `admin`, Roles: `admin,connector`, Password marked as changed |
| Viewer user | Username: `viewer`, Password: `viewer`, Roles: `viewer` |
| Connector user | Username: `connector`, Password: `connector`, Roles: `connector` |
| Sample database | Name: `demo_db`, Host: `localhost`, Port: `5432`, Database: `postgres`, User: `postgres`, Password: `postgres` |
| Sample grants | `connector` â†’ `demo_db` (write, 10 years), `viewer` â†’ `demo_db` (read, 10 years) |

**Note**: Unlike test mode, this does NOT wipe existing data. If admin user already exists, skip user creation. This allows demo instances to accumulate user-created data.

### 7. API Changes

#### 7.1 Version Endpoint Enhancement

`GET /api/v1/version` response should include run mode:

```json
{
  "version": "1.0.0",
  "commit": "abc123",
  "build_time": "2026-01-10T12:00:00Z",
  "run_mode": "demo"
}
```

**Values for `run_mode`**:
- `""` (empty string) - normal production mode
- `"test"` - test mode (E2E testing)
- `"demo"` - demo mode

#### 7.2 Error Responses

New error codes for demo mode restrictions:

| Error Code | HTTP Status | When |
|------------|-------------|------|
| `password_change_disabled_in_demo_mode` | 403 | Attempting to change admin password |
| `demo_mode_localhost_only` | 400 | Creating/updating database with non-localhost host |

### 8. Comparison: Test Mode vs Demo Mode

| Aspect | Test Mode | Demo Mode |
|--------|-----------|-----------|
| Purpose | E2E testing | Public demos & trials |
| Data on startup | Wipes everything, creates fresh | Preserves existing, creates if empty |
| Admin password | `admintest` | `admin` |
| Password change | Allowed | Blocked for admin |
| Database hosts | Any | Localhost only |
| UI indicator | None | "Demo Mode" badge |
| Pre-filled forms | No | Yes (login, database host) |

## Implementation Plan

### Backend Changes

1. **Config**: Add `demo` as valid `RunMode` in config parsing
2. **Startup**: Add demo mode initialization logic (sample data creation)
3. **API - Password**: Add demo mode check in password change handlers
4. **API - Databases**: Add host validation in create/update handlers
5. **API - Version**: Add `run_mode` field to response

### Frontend Changes

1. **Context/Hook**: Fetch and expose run mode from version endpoint
2. **DemoModeBadge**: New component for bottom-left indicator
3. **LoginPage**: Conditional pre-filling of credentials
4. **DatabaseForm**: Conditional read-only host field with pre-fill
5. **UserSettings**: Hide password change for admin in demo mode

## Security Considerations

1. **Never use in production**: Demo mode intentionally weakens security. The startup warning should be prominent.

2. **Localhost restriction rationale**: Prevents demo instances from being weaponized to probe internal networks or connect to production databases.

3. **Password protection rationale**: Ensures demo always works with documented credentials. Users testing the API won't accidentally lock themselves out.

4. **Consider rate limiting**: Public demos may benefit from aggressive rate limiting to prevent abuse.

## Open Questions

1. **Docker service names**: Should we allow docker-compose service names by default, or require explicit configuration via `DBB_DEMO_ALLOWED_HOSTS`?
   - **Recommendation**: Require explicit config. Default to strict localhost-only.

2. **Data reset**: Should demo mode support periodic data reset (e.g., every 24 hours)?
   - **Recommendation**: Out of scope for initial implementation. Operators can use cron + restart if needed.

3. **Feature flags**: Should demo mode disable any features (e.g., user deletion, database deletion)?
   - **Recommendation**: No. Let users fully explore. Sample data recreation on restart handles cleanup.

4. **Branding**: Should the demo badge be customizable (text, color)?
   - **Recommendation**: Not initially. Keep it simple and recognizable.

## Future Enhancements

- **Guided tour**: Add optional interactive tutorial for first-time users in demo mode
- **Reset button**: Add UI button to reset demo to initial state (admin only)
- **Usage analytics**: Track demo usage patterns (opt-in) to understand user exploration
- **Time-limited sessions**: Auto-logout after X minutes of inactivity in demo mode
