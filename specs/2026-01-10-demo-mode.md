# Demo Mode (DBB_RUN_MODE=demo)

## Overview

Add a new run mode `demo` designed for public demos, trials, and showcases. Demo mode provides a safe, resettable environment where users can explore DBBat with easy-to-remember credentials, pre-filled forms, and protection against breaking the demo instance.

## Goals

1. **Easy onboarding**: Pre-filled credentials (`admin`/`admin`) and forms reduce friction
2. **Safe by default**: Prevent connection to external databases (localhost only)
3. **Resilient**: Admin user cannot be deleted or locked out; data resets on restart
4. **Clear context**: Visual indicator ensures users know they're in demo mode

## Requirements

### 1. Run Mode Activation

**Environment variable**: `DBB_RUN_MODE=demo`

**Startup behavior**:
1. Log warning: `"WARNING: Running in DEMO mode. Do not use in production environments."`
2. Wipe all existing data (clean slate on every restart)
3. Run migrations
4. Create sample data (see section 6)

### 2. Admin User Protection

The admin user is protected in demo mode to ensure the demo always remains accessible.

#### 2.1 Password Protection

**Requirement**: Admin password must always remain `admin`/`admin`.

| Layer | Behavior |
|-------|----------|
| API | `PUT /api/v1/auth/password` and `PUT /api/v1/users/:uid/password` return `403` with error `"password_change_disabled_in_demo_mode"` when targeting admin user |
| Frontend | Hide "Change Password" option for admin user |
| Startup | Set admin password to `admin`, marked as changed (no forced password change flow) |

**Note**: Non-admin users CAN change their passwords.

#### 2.2 Deletion Protection

**Requirement**: Admin user cannot be deleted in demo mode.

| Layer | Behavior |
|-------|----------|
| API | `DELETE /api/v1/users/:uid` returns `403` with error `"admin_deletion_disabled_in_demo_mode"` when targeting admin user |
| Frontend | Hide delete button/option for admin user, or disable with tooltip |

**Note**: Non-admin users CAN be deleted.

### 3. Localhost-Only Database Restriction

**Requirement**: Target database hosts must be localhost only.

**Default allowed hosts**:
- `localhost`
- `127.0.0.1`
- `::1` (IPv6 loopback)

**Configuration** (for docker-compose scenarios):
```
DBB_DEMO_ALLOWED_HOSTS=localhost,127.0.0.1,::1,postgres,db
```

When set, this replaces the default list entirely.

**Implementation**:

| Layer | Behavior |
|-------|----------|
| API | `POST /api/v1/databases` and `PUT /api/v1/databases/:uid` validate host against allowed list. Return `400` with error `"demo_mode_localhost_only"` if validation fails |
| Frontend | Pre-fill host field with `localhost`, make it read-only with tooltip explaining restriction |

### 4. Visual "Demo Mode" Indicator

**Component**: Fixed badge in bottom-left corner of the application.

**Design**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚                        Main Application                      â”‚
â”‚                                                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ® Demo Mode                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Specifications**:
- **Position**: Fixed, bottom-left corner (16px from edges)
- **Style**: Pill/badge with amber/yellow background
- **Text**: "Demo Mode"
- **Tooltip on hover**: "Running in demo mode. Login: admin / admin. Data resets on restart."
- **Z-index**: Always visible, but below modals

### 5. Pre-filled Fields

#### 5.1 Login Page

| Field | Value | Editable |
|-------|-------|----------|
| Username | `admin` | Yes |
| Password | `admin` | Yes |

**Helper text**: Display "Demo credentials pre-filled" below the form or as an info banner.

#### 5.2 Database Creation/Edit Form

| Field | Value | Editable |
|-------|-------|----------|
| Host | `localhost` | No (read-only) |
| Port | `5432` | Yes |
| Database | (empty) | Yes |
| Username | (empty) | Yes |
| Password | (empty) | Yes |
| SSL Mode | `disable` | Yes |

**Tooltip for host field**: "In demo mode, only localhost connections are allowed."

### 6. Sample Data on Startup

Created fresh on every startup after data wipe:

| Entity | Details |
|--------|---------|
| Admin user | Username: `admin`, Password: `admin`, Roles: `admin,connector`, Password changed: `true` |
| Viewer user | Username: `viewer`, Password: `viewer`, Roles: `viewer`, Password changed: `true` |
| Connector user | Username: `connector`, Password: `connector`, Roles: `connector`, Password changed: `true` |
| Sample database | Name: `demo_db`, Host: `localhost`, Port: `5432`, Database: `postgres`, User: `postgres`, Password: `postgres` |
| Sample grants | `connector` â†’ `demo_db` (write, 10 years), `viewer` â†’ `demo_db` (read, 10 years) |

### 7. API Changes

#### 7.1 Version Endpoint

`GET /api/v1/version` includes run mode:

```json
{
  "version": "1.0.0",
  "commit": "abc123",
  "build_time": "2026-01-10T12:00:00Z",
  "run_mode": "demo"
}
```

**Values**: `""` (production), `"test"`, `"demo"`

#### 7.2 New Error Codes

| Error Code | HTTP Status | Condition |
|------------|-------------|-----------|
| `password_change_disabled_in_demo_mode` | 403 | Changing admin password in demo mode |
| `admin_deletion_disabled_in_demo_mode` | 403 | Deleting admin user in demo mode |
| `demo_mode_localhost_only` | 400 | Database host not in allowed list |

### 8. Comparison: Test Mode vs Demo Mode

| Aspect | Test Mode | Demo Mode |
|--------|-----------|-----------|
| **Purpose** | Automated E2E testing | Public demos & trials |
| **Data on startup** | Wipes and recreates | Wipes and recreates |
| **Admin password** | `admintest` | `admin` |
| **Admin password change** | Allowed | Blocked |
| **Admin deletion** | Allowed | Blocked |
| **Database hosts** | Any | Localhost only |
| **UI indicator** | None | "Demo Mode" badge |
| **Pre-filled forms** | No | Yes |

**Key distinction**: Test mode is for automated testing with full API access. Demo mode is for public exposure with protections against malicious users breaking the demo.

## Implementation Plan

### Backend Changes

1. **Config**: Add `demo` as valid `RunMode` enum value
2. **Startup**:
   - Add demo mode initialization (wipe + migrate + seed)
   - Share seeding logic with test mode where possible
3. **API - Users**:
   - Block admin password change in demo mode
   - Block admin deletion in demo mode
4. **API - Databases**: Add host validation against allowed list
5. **API - Version**: Add `run_mode` field to response
6. **Config**: Add `DBB_DEMO_ALLOWED_HOSTS` parsing

### Frontend Changes

1. **Context/Hook**: Fetch run mode from version endpoint on app init
2. **DemoModeBadge**: New fixed-position component
3. **LoginPage**: Conditional pre-fill of credentials + helper text
4. **DatabaseForm**: Read-only host field with pre-fill and tooltip
5. **UserList/UserDetail**: Hide delete option for admin in demo mode
6. **UserSettings**: Hide password change for admin in demo mode

## Security Considerations

1. **Production warning**: Demo mode intentionally weakens security. Startup log should be prominent and unmissable.

2. **Localhost restriction**: Prevents demo instances from probing internal networks or connecting to production databases.

3. **Admin protection**: Ensures demo always works with documented credentials. Malicious users cannot lock out legitimate demo users.

4. **Rate limiting**: Consider aggressive rate limiting for public-facing demo instances (implementation outside this spec).

## Future Enhancements

- **Guided tour**: Interactive tutorial for first-time users
- **Manual reset button**: UI button to reset demo without restart (admin only)
- **Usage analytics**: Opt-in tracking of demo exploration patterns
- **Time-limited sessions**: Auto-logout after inactivity
