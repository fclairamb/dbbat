services:
  # PostgreSQL database for both DBBat storage and target database
  postgres:
    image: postgres:15
    container_name: dbbat-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5002:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
    command:
      [
        "postgres",
        "-c",
        "hba_file=/etc/postgresql/pg_hba.conf",
        "-c",
        "password_encryption=md5",
      ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # DBBat proxy
  dbbat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dbbat-server
    environment:
      DBB_LISTEN_PG: ":5432"
      DBB_LISTEN_API: ":8080"
      DBB_DSN: "postgres://postgres:postgres@postgres:5432/dbbat?sslmode=disable"
      DBB_KEY: "MDEyMzQ1Njc4OTAxMjM0NTY3ODkwMTIzNDU2Nzg5MDE=" # base64 encoded 32-byte key: "01234567890123456789012345678901"
    ports:
      - "5001:5432" # Proxy port
      - "8080:8080" # API port
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres-data:
